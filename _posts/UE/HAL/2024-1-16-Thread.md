---
layout: post
title: "Thread"
date: 2024-1-16 09:00:00 +0800 
categories: UE
tag: HAL
---
* content
{:toc #markdown-toc}

ä¸€äº›å…³äºUEçš„Threadçš„çŸ¥è¯†

<!-- more -->





# æ³¨æ„

## What Not to Doä¸è¯¥åšä»€ä¹ˆ

- ä¸è¦å°è¯•åœ¨å…¶ä»–çº¿ç¨‹ä¿®æ”¹ã€åˆ›å»ºæˆ–åˆ é™¤ UObjectï¼

æ‚¨å¯ä»¥å‡†å¤‡æ‰€æœ‰æ•°æ®/æ‰§è¡Œæ‰€æœ‰è®¡ç®—ï¼Œä½†åªæœ‰æ¸¸æˆçº¿ç¨‹åº”è¯¥å®é™…ç”Ÿæˆ/ä¿®æ”¹/åˆ é™¤ UObjects/AActorsã€‚

- Dont try to use TimerManager outside of the game thread ğŸ˜ƒä¸è¦å°è¯•åœ¨æ¸¸æˆçº¿ç¨‹ä¹‹å¤–ä½¿ç”¨ TimerManager ğŸ˜ƒ
- Don't try to draw debug lines/points etc, as it will likely crash, ie DrawDebugLine(etc...)ä¸è¦å°è¯•ç»˜åˆ¶è°ƒè¯•çº¿/ç‚¹ç­‰ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå´©æºƒï¼Œå³ DrawDebugLine(etc...)

Notice (since 4.11):æ³¨æ„ï¼ˆè‡ª4.11èµ·ï¼‰ï¼š

If you want to use the timer, remove, and modify variables use it:å¦‚æœæ‚¨æƒ³ä½¿ç”¨è®¡æ—¶å™¨ã€åˆ é™¤å’Œä¿®æ”¹å˜é‡ï¼Œè¯·ä½¿ç”¨å®ƒï¼š

\#include "Async.h" ... AsyncTask(ENamedThreads::GameThread, []() { // code to execute on game thread here });#includeâ€œå¼‚æ­¥.hâ€ ... AsyncTask(ENamedThreads::GameThread, []() { // åœ¨æ¸¸æˆçº¿ç¨‹ä¸Šæ‰§è¡Œçš„ä»£ç  });

# é‡åˆ°çš„é—®é¢˜

## å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å¼•ç”¨æ•è·å¤±è´¥

é—®é¢˜æè¿°ï¼šUEä¸­ä½¿ç”¨runnableåˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹é‡Œä½¿ç”¨AsyncTask(ENamedThreads::Type::GameThread,\[Location,Rotation,this\](){}å¯ä»¥æ•è·Locationå’ŒRotationä½†æ˜¯å¦‚æœä½¿ç”¨å¼•ç”¨æ•è·åˆ™ä¸è¡Œï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆ

```c++
//å½“å‰çº¿ç¨‹ï¼šRunnableçš„çº¿ç¨‹
FVector Location = FVector(lon,lat,alt);
FRotator Rotation = FRotator(pitch,heading,roll);
AsyncTask(ENamedThreads::Type::GameThread,[/*&*/Location,/*&*/Rotation,this]()
{
    UE_LOG(LogTemp,Warning,TEXT("%f"),Location.X);
    if (!OnReceiveSyncTrans.ExecuteIfBound(Location, Rotation))
    {
       UE_LOG(LogTemp,Warning,TEXT("OnReceiveSyncTrans not execute"));
    }
});
```

<font color=yellow>ä½¿ç”¨å¼•ç”¨æ•è·Locationå’ŒRotationå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚å› ä¸ºåœ¨åˆ›å»ºLambdaè¡¨è¾¾å¼æ—¶ï¼ŒLocationå’ŒRotationå¯èƒ½å·²ç»è¶…å‡ºäº†å®ƒä»¬çš„ä½œç”¨åŸŸï¼Œåœ¨Lambdaæ‰§è¡Œæ—¶å¯èƒ½æ‰¾ä¸åˆ°è¿™äº›å˜é‡çš„æœ‰æ•ˆå¼•ç”¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¼•ç”¨æ•è·Locationå’ŒRotationå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜çš„åŸå› ã€‚</font>

<font color=yellow>è¶…å‡ºä½œç”¨åŸŸåLocationå’ŒRotationçš„ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œå¯¼è‡´æ— æ•ˆï¼Œè€Œthiså…³é”®å­—é»˜è®¤æ˜¯ä»¥å¼•ç”¨çš„æ–¹å¼æ•è·çš„ï¼Œå› æ­¤åœ¨Lambdaä¸­å¯ä»¥è®¿é—®thisæŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡çš„æˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°ã€‚</font>**æ‚¬å‚å¼•ç”¨ï¼š**è‹¥ä»¥å¼•ç”¨éšå¼æˆ–æ˜¾å¼æ•è·éå¼•ç”¨å®ä½“ï¼Œè€Œåœ¨è¯¥å®ä½“çš„ç”Ÿå­˜æœŸç»“æŸä¹‹åè°ƒç”¨lambdaå¯¹è±¡çš„å‡½æ•°è°ƒç”¨è¿ç®—ç¬¦ï¼Œåˆ™å‘ç”Ÿæœªå®šä¹‰è¡Œä¸ºã€‚C++ çš„é—­åŒ…å¹¶ä¸å»¶é•¿è¢«æ•è·çš„å¼•ç”¨çš„ç”Ÿå­˜æœŸã€‚è¿™åŒæ ·é€‚ç”¨äºè¢«æ•è·çš„thisæŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡çš„ç”Ÿå­˜æœŸã€‚<font color=yellow>å› æ­¤ï¼Œåœ¨ä½¿ç”¨thisæ•è·çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç¡®ä¿Lambdaçš„æ‰§è¡Œå‘ç”Ÿåœ¨thisæŒ‡å‘çš„å¯¹è±¡çš„æœ‰æ•ˆç”Ÿå‘½å‘¨æœŸå†…ã€‚</font>

# è·å–å½“å‰çº¿ç¨‹IDå’Œåå­—

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹IDï¼Œçº¿ç¨‹IDåœ¨å®ƒæ‰€å±çš„è¿›ç¨‹ç¯å¢ƒä¸­æœ‰æ•ˆã€‚ä¸ºå¢åŠ æ ‡è¯†æ€§ï¼ŒUE4è¿˜å¢åŠ äº†çº¿ç¨‹åç§°ã€‚çº¿ç¨‹IDæ˜¯å”¯ä¸€çš„ï¼Œçº¿ç¨‹åç§°å¯ä»¥é‡å¤ã€‚å¯é€šè¿‡`GetThreadID`å’Œ `GetThreadName` è·å–çº¿ç¨‹IDå’Œåç§°ã€‚

```c++
uint32 CurrentThreadId = FPlatformTLS::GetCurrentThreadId();
FString CurrentThreadName = FThreadManager::Get().GetThreadName(CurrentThreadId);
```

# FRunnableçš„ä½¿ç”¨

> å‚è€ƒï¼š[UE4å¤šçº¿ç¨‹FRunnable](https://zhuanlan.zhihu.com/p/571515841)

FRunnableæ˜¯UE4ä¸­å¤šçº¿ç¨‹çš„å®ç°æ–¹å¼ä¹‹ä¸€ï¼Œé€‚ç”¨äºå¤æ‚è¿ç®—ã€‚

FRunnableéœ€è¦ä¾é™„ä¸ä¸€ä¸ª`FRunnableThread`å¯¹è±¡ï¼Œæ‰èƒ½è¢«æ‰§è¡Œã€‚

1. FRunnableThreadé€šè¿‡FRunnableThread::Createæ¥è°ƒç”¨å¯¹åº”å¹³å°çš„æ¥å£æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶è°ƒç”¨ FRunnable å¯¹è±¡çš„Initï¼ŒRunç­‰äº‹ä»¶ã€‚Createæ‰§è¡Œä¹‹åï¼Œå¯¹åº”çš„çº¿ç¨‹å‡½æ•°Runç«‹å³æ‰§è¡Œï¼Œå¹¶æ²¡æœ‰Startä¹‹ç±»çš„æ–¹æ³•ã€‚
2. FRunnableå®šä¹‰äº†Init()ï¼ŒRun()ï¼ŒExit()ç­‰è™šå‡½æ•°ï¼Œé¦–å…ˆæ‰§è¡ŒInitï¼Œåˆå§‹åŒ–å®Œæˆåæ‰§è¡ŒRunï¼ŒRunæ‰§è¡Œå®Œæ¯•ä¹‹åæ‰§è¡ŒExitã€‚
   ä¸»åŠ¨è°ƒç”¨Stopï¼Œå¯ä»¥æå‰ç»ˆæ­¢çº¿ç¨‹ã€‚
3. å¦‚æœè¦ç»“æŸçº¿ç¨‹ï¼Œå¯ä»¥è°ƒç”¨FRunnableThreadçš„Killæ–¹æ³•ã€‚Killæ–¹æ³•ä»…ä»…è°ƒç”¨äº†RunnableObjectçš„Stopæ–¹æ³•(æ—¢ç„¶ä½ å·²ç»æ‹¿åˆ°äº†RunnableObjectï¼Œå°±ç›´æ¥è°ƒç”¨Stopæ–¹æ³•å³å¯)ï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨åœ¨Stopæ–¹æ³•ä¸­å°†é€€å‡ºä¿¡æ¯ä¼ é€’ç»™Runå‡½æ•°ï¼Œä»è€Œç»“æŸRunæ–¹æ³•ã€‚

```c++
class FMyRunnable : public FRunnable
{
protected:
    // FRunnable interface
    virtual bool Init() override;// åˆå§‹åŒ– runnable å¯¹è±¡ï¼Œåœ¨FRunnableThreadåˆ›å»ºçº¿ç¨‹å¯¹è±¡åè°ƒç”¨
    virtual uint32 Run() override;// Runnable å¯¹è±¡é€»è¾‘å¤„ç†ä¸»ä½“ï¼Œåœ¨InitæˆåŠŸåè°ƒç”¨
    virtual void Stop() override;// åœæ­¢ runnable å¯¹è±¡, çº¿ç¨‹æå‰ç»ˆæ­¢æ—¶è¢«ç”¨æˆ·è°ƒç”¨ å¦‚ï¼šKill()æˆ–ç›´æ¥è°ƒç”¨Stop()
    virtual void Exit() override;// é€€å‡º runnable å¯¹è±¡ï¼Œç”±FRunnableThreadè°ƒç”¨ï¼Œåœ¨Runå‡½æ•°returnåä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚
    // ~FRunnable interface

private:
	FRunnableThread* Thread;
	FThreadSafeBool bRunning;
}
```

```c++
//D:\UE_5.4\Engine\Source\Runtime\Core\Private\Windows\WindowsRunnableThread.cpp ç”¨Windowså¹³å°ä¸¾ä¾‹
uint32 FRunnableThreadWin::Run()
{
    uint32 ExitCode = 1;
    check(Runnable);

    if (Runnable->Init() == true)	//åˆå§‹åŒ– runnable å¯¹è±¡ï¼Œåœ¨FRunnableThreadåˆ›å»ºçº¿ç¨‹å¯¹è±¡åè°ƒç”¨
    {
       ThreadInitSyncEvent->Trigger();

       SetTls();

       ExitCode = Runnable->Run();	// Runnable å¯¹è±¡é€»è¾‘å¤„ç†ä¸»ä½“ï¼Œåœ¨InitæˆåŠŸåè°ƒç”¨

       Runnable->Exit();			// é€€å‡º runnable å¯¹è±¡ï¼Œç”±FRunnableThreadè°ƒç”¨

#if STATS
       FThreadStats::Shutdown();
#endif
       FreeTls();
    }
    else
    {
       ThreadInitSyncEvent->Trigger();
    }

    return ExitCode;
}
```

```c++
//D:\UE_5.4\Engine\Source\Runtime\Core\Private\Microsoft\MicrosoftRunnableThread.h
// Killå‡½æ•°å¤§è‡´å¦‚ä¸‹ï¼Œä¼šå…ˆè°ƒç”¨Runnableçš„Stopå‡½æ•°ï¼Œè€Œä¸”åº”å½“æ³¨æ„ï¼Œå¦‚æœSuspend(true)æ—¶è°ƒç”¨Kill(false)ä¼šå´©
virtual bool Kill(bool bShouldWait) override
{
   // Let the runnable have a chance to stop without brute force killing
   if (Runnable)
   {
      Runnable->Stop();
   }

   if (bShouldWait == true)
   {
      // Wait indefinitely for the thread to finish.  IMPORTANT:  It's not safe to just go and
      // kill the thread with TerminateThread() as it could have a mutex lock that's shared
      // with a thread that's continuing to run, which would cause that other thread to
      // dead-lock.  
      //
      // This can manifest itself in code as simple as the synchronization
      // object that is used by our logging output classes

      WaitForSingleObject(Thread, INFINITE);
   }

   CloseHandle(Thread);
   Thread = NULL;

   return bDidExitOK;
}
```

## è·å–çº¿ç¨‹åå­—

FRunnableæœ‰è‡ªå·±çš„è·å–åå­—å’ŒIDçš„æ–¹æ³•éœ€è¦é€šè¿‡FRunnableThreadè°ƒç”¨

```c++
Thread->GetThreadName();
```

å½“ç„¶é€šè¿‡`FThreadManager`ä»ç„¶æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºé€šè¿‡FRunnableThread åˆ›å»ºçš„çº¿ç¨‹æ˜¯é€šè¿‡`FThreadManager`è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚

```c++
FThreadManager::Get().AddThread(ThisThread->GetThreadID(), ThisThread);
```

# **UEå¤šçº¿ç¨‹æºç å‰–æ**

> å‚è€ƒï¼š[å¼•æ“æ¶æ„å‰–æâ€”â€”UE4å¤šçº¿ç¨‹ä½¿ç”¨å’Œåˆ†æ(ä¸‰)](https://zhuanlan.zhihu.com/p/648526369)

## GraphTask

**GraphTask**æ˜¯Unreal Engine 4ä¸­çš„ä¸€ä¸ªä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œç”¨äºå¹¶è¡Œæ‰§è¡Œä»»åŠ¡å’Œç®¡ç†ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ŒGraph Taskå¯ä»¥å°†ä»»åŠ¡åˆ†é…ç»™å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„è®¡ç®—èƒ½åŠ›,å¹¶ä¸”å¯ä»¥ç®¡ç†ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç¡®ä¿ä»»åŠ¡æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œã€‚ä¾èµ–å…³ç³»ä¸»è¦é€šè¿‡è®¾ç½®Prerequisitesæ¥å®ç°ã€‚GraphTaskå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°å¼‚æ­¥å’ŒåŸºäºä¼˜å…ˆçº§æ‰§è¡Œã€‚æ˜¯ä¸€ç§å¯¹ä»»åŠ¡å¾ˆæ–¹ä¾¿ç®¡ç†çš„ç±»ã€‚

![img](https://pica.zhimg.com/v2-1e057f202c6f20d492907740913c0208_1440w.jpg)

ä¾èµ–å…³ç³»çš„å®ç°å¹¶ä¸å¤æ‚ï¼Œå¦‚ä¸Šä¸»è¦æ˜¯è®¡ç®—Prerequisitesåˆ—è¡¨æ‰€ä»¥å¾—Graphé˜Ÿåˆ—æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œå…¨éƒ¨æ‰§è¡Œå®Œå†è¿è¡Œæ‰§è¡Œè¯¥Graphã€‚é€šè¿‡ä½¿ç”¨TGraphTaskï¼Œå¼€å‘è€…å¯ä»¥å°†æ¸¸æˆä¸­çš„å¤æ‚è®¡ç®—å’Œä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªã€‚

## FTaskGraphImplementation

**FTaskGraphImplementation**æ˜¯çœŸæ­£ä¸º**T**GraphTaskæœåŠ¡å’Œç®¡ç†çš„ç±»ï¼Œè´Ÿè´£åˆ›å»ºå’Œç®¡ç†ä»»åŠ¡å›¾ï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªä»»åŠ¡èŠ‚ç‚¹å’Œå®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚å®ƒä¼šæ ¹æ®ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»å’Œä¼˜å…ˆçº§æ¥ç¡®å®šä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼Œå¹¶å°†ä»»åŠ¡åˆ†é…ç»™å¯ç”¨çš„çº¿ç¨‹è¿›è¡Œå¹¶è¡Œæ‰§è¡Œã€‚å®ƒä¼šæ ¹æ®ç³»ç»Ÿçš„ç¡¬ä»¶é…ç½®å’Œä»»åŠ¡çš„è´Ÿè½½æƒ…å†µæ¥åŠ¨æ€è°ƒæ•´çº¿ç¨‹çš„æ•°é‡ï¼Œä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„è®¡ç®—èƒ½åŠ›ã€‚

## FAsyncTask

**FAsyncTask**æ˜¯Unreal Engine 4ä¸­çš„ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ç®¡ç†ç±»ï¼Œå¯ä»¥å°†è€—æ—¶çš„æ“ä½œè®¾ç½®ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œå¯ä»¥è®¾ç½®ä»»åŠ¡å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå¯ä»¥å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å¯ä»¥ä¸ºä»»åŠ¡è®¾ç½®ä¼˜å…ˆçº§ï¼Œä»¥ç¡®ä¿é‡è¦çš„ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œã€‚FAsyncTaské€‚ç”¨äºéœ€è¦åœ¨åå°æ‰§è¡Œçš„ç‹¬ç«‹ä»»åŠ¡ï¼Œå¦‚æ–‡ä»¶åŠ è½½ã€ç½‘ç»œè¯·æ±‚ã€å¤æ‚è®¡ç®—ç­‰ã€‚å®ƒå¯ä»¥åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œå¦‚æ›´æ–°æ¸¸æˆçŠ¶æ€ã€åˆ·æ–°UIç­‰ã€‚è€ŒTGraphTaské€‚ç”¨äºéœ€è¦å¹¶è¡Œå¤„ç†çš„ä»»åŠ¡é›†åˆï¼Œå¤„ç†ä¾èµ–å…³ç³»ä¿è¯é¡ºåºç­‰ç­‰ï¼Œå¦‚å¤æ‚çš„è®¡ç®—ã€æ¸²æŸ“ï¼ŒåŠ¨ç”»ï¼Œç‰©ç†æ•°æ®æ›´æ–°ç­‰ã€‚

## FRunnable

**FRunnable**æ˜¯UEæ›´åº•å±‚çš„æ§åˆ¶çº¿ç¨‹æœºåˆ¶çš„ç±»ï¼Œæä¾›äº†ä¸€äº›æ–¹æ³•æ¥æ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œï¼Œå¦‚å¯åŠ¨çº¿ç¨‹ã€æš‚åœçº¿ç¨‹ã€æ¢å¤çº¿ç¨‹å’Œåœæ­¢çº¿ç¨‹ç­‰ï¼Œä¹Ÿæä¾›äº†ä¸€äº›çº¿ç¨‹åŒæ­¥çš„æœºåˆ¶ï¼Œå¦‚äº’æ–¥é”ï¼ˆMutexï¼‰å’Œä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼Œç”¨äºä¿æŠ¤å…±äº«èµ„æºçš„è®¿é—®ï¼Œé¿å…å¤šçº¿ç¨‹ç«äº‰å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚FRunnableå®šä¹‰äº†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„åˆ›å»ºã€å¯åŠ¨ã€æ‰§è¡Œå’Œç»“æŸç­‰ã€‚å¼€å‘è€…å¯ä»¥æ ¹æ®éœ€è¦å®ç°ç›¸åº”çš„æ–¹æ³•æ¥ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚æ€»ä¹‹è¿™æ˜¯ä¸€ä¸ªæ›´åº•å±‚çš„æ§åˆ¶çº¿ç¨‹çš„ç±»æ–¹æ³•ã€‚

**FRunnableThread** å¯ä»¥åˆ›å»ºå’Œç®¡ç†åå°çº¿ç¨‹ï¼Œç”¨äºæ‰§è¡ŒFRunnableä¸­å®šä¹‰çš„ä»»åŠ¡ã€‚FRunnableThreadæ˜¯ä¸€ä¸ªçº¿ç¨‹ç®¡ç†ç±»ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†åå°çº¿ç¨‹ã€‚å®ƒæä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥å¯åŠ¨ã€æš‚åœã€æ¢å¤å’Œåœæ­¢çº¿ç¨‹ã€‚è€ŒFRunnableæ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºå®šä¹‰å¯è¿è¡Œçš„çº¿ç¨‹ç±»ã€‚å®ƒå®šä¹‰äº†çº¿ç¨‹çš„æ‰§è¡Œé€»è¾‘å’Œä»»åŠ¡ï¼Œå¹¶æä¾›äº†çº¿ç¨‹åŒæ­¥å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†çš„åŠŸèƒ½ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ç»§æ‰¿FRunnableæ¥å£æ¥å®ç°è‡ªå®šä¹‰çš„å¯è¿è¡Œçº¿ç¨‹ç±»ï¼Œå¹¶åœ¨FRunnableThreadä¸­åˆ›å»ºå’Œç®¡ç†è¯¥çº¿ç¨‹ã€‚FRunnableThreadä¼šè°ƒç”¨FRunnableçš„æ–¹æ³•æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶æä¾›çº¿ç¨‹åŒæ­¥å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æ”¯æŒã€‚ç®€å•è¯´æ¥å°±æ˜¯ä¸€ä¸ªæ˜¯çº¿ç¨‹ç®¡ç†å™¨ï¼Œä¸€ä¸ªæ˜¯çº¿ç¨‹ç±»æœ¬èº«ã€‚

![img](https://pic1.zhimg.com/v2-4b0ce1d14d8a1d2d7c54ff121b8b64d2_1440w.jpg)

## FQueuedThreadPool

**FQueuedThreadPool**æ˜¯UE4çš„çº¿ç¨‹æ± ï¼Œç”¨äºç®¡ç†å’Œè°ƒåº¦å¤šä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚çº¿ç¨‹æ± å†…æœ‰å¤§é‡çš„QueueWorkæ¥ç®¡ç†çº¿ç¨‹ï¼ŒåŒ…æ‹¬å¾…æ‰§è¡Œçº¿ç¨‹ï¼Œæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å’Œæ‰€æœ‰çº¿ç¨‹ã€‚åœ¨UEä¸­æœ‰IOçº¿ç¨‹æ± [GIOThreadPool](https://zhida.zhihu.com/search?content_id=232247002&content_type=Article&match_order=1&q=GIOThreadPool&zhida_source=entity) ï¼Œåå°çº¿ç¨‹æ± GBackgroundPriorityThreadPool ï¼Œä»¥åŠæ¸¸æˆçº¿ç¨‹æ± GThreadPoolã€‚çº¿ç¨‹æ± ä¸»è¦æ˜¯ç»™FAsyncTaskä½¿ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¿™ç±»çš„å¼‚æ­¥Taskå…¨éƒ¨æ˜¯é€šè¿‡çº¿ç¨‹æ± æ¥æ‰§è¡Œä»»åŠ¡çš„ã€‚

## ParallelForImpl

**ParallelForImpl**å¹¶è¡Œè®¡ç®—ç”¨äºå®ç°å¹¶è¡Œå¾ªç¯æ‰§è¡Œä»»åŠ¡çš„åŠŸèƒ½ã€‚å®ƒå¯ä»¥å°†ä¸€ä¸ªä»»åŠ¡åˆ†å‰²æˆå¤šä¸ªå­ä»»åŠ¡ï¼Œå¹¶åœ¨å¤šä¸ªçº¿ç¨‹ä¸Šå¹¶è¡Œæ‰§è¡Œè¿™äº›å­ä»»åŠ¡ï¼Œä»¥æé«˜æ‰§è¡Œæ•ˆç‡å’Œæ€§èƒ½ã€‚æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥æ§åˆ¶å¾ªç¯çš„è¿­ä»£æ¬¡æ•°å’Œç´¢å¼•èŒƒå›´ã€‚ParallelForä¼šè‡ªåŠ¨å¤„ç†çº¿ç¨‹åŒæ­¥å’Œä»»åŠ¡åˆ†é…çš„ç»†èŠ‚ï¼Œç¡®ä¿å­ä»»åŠ¡åœ¨ä¸åŒçº¿ç¨‹ä¸Šæ­£ç¡®åœ°æ‰§è¡Œï¼Œå¹¶åœ¨æ‰€æœ‰å­ä»»åŠ¡å®Œæˆåè¿›è¡Œåˆå¹¶ã€‚è¿™æ ·å¯ä»¥é¿å…å¤šçº¿ç¨‹ç«äº‰å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚ã€‚å®ƒé€šè¿‡ä»»åŠ¡åˆ†å‰²å’Œçº¿ç¨‹åŒæ­¥æ¥å®ç°ä»»åŠ¡çš„å¹¶è¡Œæ‰§è¡Œï¼Œå¹¶æ ¹æ®ç³»ç»Ÿçš„ç¡¬ä»¶é…ç½®å’Œä»»åŠ¡çš„è´Ÿè½½æƒ…å†µè¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ParallelForImplæ¥è‡ªå®šä¹‰å¹¶è¡Œå¾ªç¯æ‰§è¡Œä»»åŠ¡çš„é€»è¾‘ï¼Œä»¥æ»¡è¶³ç‰¹å®šçš„éœ€æ±‚å’Œä¼˜åŒ–è¦æ±‚ã€‚

![img](https://pic2.zhimg.com/v2-385cc86c223f46ebc7a35b2a7a38f215_1440w.jpg)

## FTaskGraphImplementation

**FTaskGraphImplementation**æ˜¯çœŸæ­£ä¸º**T**GraphTaskæœåŠ¡å’Œç®¡ç†çš„ç±»ï¼Œè´Ÿè´£åˆ›å»ºå’Œç®¡ç†ä»»åŠ¡å›¾ï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªä»»åŠ¡èŠ‚ç‚¹å’Œå®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚å®ƒä¼šæ ¹æ®ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»å’Œä¼˜å…ˆçº§æ¥ç¡®å®šä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼Œå¹¶å°†ä»»åŠ¡åˆ†é…ç»™å¯ç”¨çš„çº¿ç¨‹è¿›è¡Œå¹¶è¡Œæ‰§è¡Œã€‚å®ƒä¼šæ ¹æ®ç³»ç»Ÿçš„ç¡¬ä»¶é…ç½®å’Œä»»åŠ¡çš„è´Ÿè½½æƒ…å†µæ¥åŠ¨æ€è°ƒæ•´çº¿ç¨‹çš„æ•°é‡ï¼Œä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„è®¡ç®—èƒ½åŠ›ã€‚

![img](https://picx.zhimg.com/v2-5ccfbffbc7a4f3773c51e565a434a717_1440w.jpg)

å‡ å¤§çº¿ç¨‹ç›¸å…³ç±»å…³ç³»

å¦‚ä¸Šå›¾ï¼Œå±•ç¤ºäº†å‡ ä¸ªçº¿ç¨‹ç›¸å…³ç±»çš„ç›¸äº’å…³ç³»ã€‚åœ¨FTaskGraphImplementationä¸­è¿˜ç®¡ç†äº†æ¸¸æˆä¸»è¦çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œä¸»è¦å·¥ä½œçº¿ç¨‹åŒ…æ‹¬WorkerThreadså·¥ä½œçº¿ç¨‹å’ŒENamedThreadsã€‚æ‰€æœ‰çš„çº¿ç¨‹æ•°æ®éƒ½å­˜å‚¨åœ¨FWorkerThread WorkerThreads[MAX_THREADS];å†…éƒ¨ã€‚å‰Nä¸ªæ˜¯NamedThreadï¼Œåè¾¹æ˜¯WorkerThread.

> å¤šçº¿ç¨‹æ•™ç¨‹é“¾æ¥ï¼š[ã€UEÂ·å¼•æ“ç¯‡ã€‘Runnableã€TaskGraphã€AsyncTaskã€Asyncå¤šçº¿ç¨‹å¼€å‘æŒ‡å—](https://blog.csdn.net/j756915370/article/details/122752719)
>
> [ã€ŠExploring in UE4ã€‹å¤šçº¿ç¨‹æœºåˆ¶è¯¦è§£(åŸç†åˆ†æ) ](https://zhuanlan.zhihu.com/p/38881269)
>
> [UE4/UE5çš„TaskGraph](https://cloud.tencent.com/developer/article/1897046)
>
> [bç«™ï¼šã€åˆé›†ã€‘UE4 C++è¿›é˜¶(è¿›è¡Œä¸­)](https://www.bilibili.com/video/BV14p4y1a7nj?p=7)
>
> [2wå­— + 40å¼ å›¾å¸¦ä½ å‚é€å¹¶å‘ç¼–ç¨‹ï¼ ](https://www.cnblogs.com/cxuanBlog/p/13523033.html)

# å‚è€ƒé“¾æ¥

> 1ï¼Œ[Multi-Threading: How to Create Threads in UE4](https://michaeljcole.github.io/wiki.unrealengine.com/Multi-Threading:_How_to_Create_Threads_in_UE4)
>
> 2ï¼Œ[UE å¤šçº¿ç¨‹](https://blog.csdn.net/qq_52825422/article/details/133884930)
>
> 3ï¼Œ[UE4å¤šçº¿ç¨‹FRunnable](https://zhuanlan.zhihu.com/p/571515841)
