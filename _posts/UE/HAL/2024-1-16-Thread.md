---
layout: post
title: "Thread"
date: 2024-1-16 09:00:00 +0800 
categories: UE
tag: HAL
---
* content
{:toc #markdown-toc}

ä¸€äº›å…³äºUEçš„Threadçš„çŸ¥è¯†

<!-- more -->





# æ³¨æ„

## What Not to Doä¸è¯¥åšä»€ä¹ˆ

- ä¸è¦å°è¯•åœ¨å…¶ä»–çº¿ç¨‹ä¿®æ”¹ã€åˆ›å»ºæˆ–åˆ é™¤ UObjectï¼

æ‚¨å¯ä»¥å‡†å¤‡æ‰€æœ‰æ•°æ®/æ‰§è¡Œæ‰€æœ‰è®¡ç®—ï¼Œä½†åªæœ‰æ¸¸æˆçº¿ç¨‹åº”è¯¥å®é™…ç”Ÿæˆ/ä¿®æ”¹/åˆ é™¤ UObjects/AActorsã€‚

- Dont try to use TimerManager outside of the game thread ğŸ˜ƒä¸è¦å°è¯•åœ¨æ¸¸æˆçº¿ç¨‹ä¹‹å¤–ä½¿ç”¨ TimerManager ğŸ˜ƒ
- Don't try to draw debug lines/points etc, as it will likely crash, ie DrawDebugLine(etc...)ä¸è¦å°è¯•ç»˜åˆ¶è°ƒè¯•çº¿/ç‚¹ç­‰ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå´©æºƒï¼Œå³ DrawDebugLine(etc...)

Notice (since 4.11):æ³¨æ„ï¼ˆè‡ª4.11èµ·ï¼‰ï¼š

If you want to use the timer, remove, and modify variables use it:å¦‚æœæ‚¨æƒ³ä½¿ç”¨è®¡æ—¶å™¨ã€åˆ é™¤å’Œä¿®æ”¹å˜é‡ï¼Œè¯·ä½¿ç”¨å®ƒï¼š

\#include "Async.h" ... AsyncTask(ENamedThreads::GameThread, []() { // code to execute on game thread here });#includeâ€œå¼‚æ­¥.hâ€ ... AsyncTask(ENamedThreads::GameThread, []() { // åœ¨æ¸¸æˆçº¿ç¨‹ä¸Šæ‰§è¡Œçš„ä»£ç  });

# é‡åˆ°çš„é—®é¢˜

## å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å¼•ç”¨æ•è·å¤±è´¥

é—®é¢˜æè¿°ï¼šUEä¸­ä½¿ç”¨runnableåˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹é‡Œä½¿ç”¨AsyncTask(ENamedThreads::Type::GameThread,\[Location,Rotation,this\](){}å¯ä»¥æ•è·Locationå’ŒRotationä½†æ˜¯å¦‚æœä½¿ç”¨å¼•ç”¨æ•è·åˆ™ä¸è¡Œï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆ

```c++
//å½“å‰çº¿ç¨‹ï¼šRunnableçš„çº¿ç¨‹
FVector Location = FVector(lon,lat,alt);
FRotator Rotation = FRotator(pitch,heading,roll);
AsyncTask(ENamedThreads::Type::GameThread,[/*&*/Location,/*&*/Rotation,this]()
{
    UE_LOG(LogTemp,Warning,TEXT("%f"),Location.X);
    if (!OnReceiveSyncTrans.ExecuteIfBound(Location, Rotation))
    {
       UE_LOG(LogTemp,Warning,TEXT("OnReceiveSyncTrans not execute"));
    }
});
```

<font color=yellow>ä½¿ç”¨å¼•ç”¨æ•è·Locationå’ŒRotationå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚å› ä¸ºåœ¨åˆ›å»ºLambdaè¡¨è¾¾å¼æ—¶ï¼ŒLocationå’ŒRotationå¯èƒ½å·²ç»è¶…å‡ºäº†å®ƒä»¬çš„ä½œç”¨åŸŸï¼Œåœ¨Lambdaæ‰§è¡Œæ—¶å¯èƒ½æ‰¾ä¸åˆ°è¿™äº›å˜é‡çš„æœ‰æ•ˆå¼•ç”¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¼•ç”¨æ•è·Locationå’ŒRotationå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜çš„åŸå› ã€‚</font>

<font color=yellow>è¶…å‡ºä½œç”¨åŸŸåLocationå’ŒRotationçš„ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œå¯¼è‡´æ— æ•ˆï¼Œè€Œthiså…³é”®å­—é»˜è®¤æ˜¯ä»¥å¼•ç”¨çš„æ–¹å¼æ•è·çš„ï¼Œå› æ­¤åœ¨Lambdaä¸­å¯ä»¥è®¿é—®thisæŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡çš„æˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°ã€‚</font>**æ‚¬å‚å¼•ç”¨ï¼š**è‹¥ä»¥å¼•ç”¨éšå¼æˆ–æ˜¾å¼æ•è·éå¼•ç”¨å®ä½“ï¼Œè€Œåœ¨è¯¥å®ä½“çš„ç”Ÿå­˜æœŸç»“æŸä¹‹åè°ƒç”¨lambdaå¯¹è±¡çš„å‡½æ•°è°ƒç”¨è¿ç®—ç¬¦ï¼Œåˆ™å‘ç”Ÿæœªå®šä¹‰è¡Œä¸ºã€‚C++ çš„é—­åŒ…å¹¶ä¸å»¶é•¿è¢«æ•è·çš„å¼•ç”¨çš„ç”Ÿå­˜æœŸã€‚è¿™åŒæ ·é€‚ç”¨äºè¢«æ•è·çš„thisæŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡çš„ç”Ÿå­˜æœŸã€‚<font color=yellow>å› æ­¤ï¼Œåœ¨ä½¿ç”¨thisæ•è·çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç¡®ä¿Lambdaçš„æ‰§è¡Œå‘ç”Ÿåœ¨thisæŒ‡å‘çš„å¯¹è±¡çš„æœ‰æ•ˆç”Ÿå‘½å‘¨æœŸå†…ã€‚</font>

# è·å–å½“å‰çº¿ç¨‹IDå’Œåå­—

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹IDï¼Œçº¿ç¨‹IDåœ¨å®ƒæ‰€å±çš„è¿›ç¨‹ç¯å¢ƒä¸­æœ‰æ•ˆã€‚ä¸ºå¢åŠ æ ‡è¯†æ€§ï¼ŒUE4è¿˜å¢åŠ äº†çº¿ç¨‹åç§°ã€‚çº¿ç¨‹IDæ˜¯å”¯ä¸€çš„ï¼Œçº¿ç¨‹åç§°å¯ä»¥é‡å¤ã€‚å¯é€šè¿‡`GetThreadID`å’Œ `GetThreadName` è·å–çº¿ç¨‹IDå’Œåç§°ã€‚

```c++
uint32 CurrentThreadId = FPlatformTLS::GetCurrentThreadId();
FString CurrentThreadName = FThreadManager::Get().GetThreadName(CurrentThreadId);
```

# FRunnableçš„ä½¿ç”¨

> å‚è€ƒï¼š[UE4å¤šçº¿ç¨‹FRunnable](https://zhuanlan.zhihu.com/p/571515841)

FRunnableæ˜¯UE4ä¸­å¤šçº¿ç¨‹çš„å®ç°æ–¹å¼ä¹‹ä¸€ï¼Œé€‚ç”¨äºå¤æ‚è¿ç®—ã€‚

FRunnableéœ€è¦ä¾é™„ä¸ä¸€ä¸ª`FRunnableThread`å¯¹è±¡ï¼Œæ‰èƒ½è¢«æ‰§è¡Œã€‚

1. FRunnableThreadé€šè¿‡FRunnableThread::Createæ¥è°ƒç”¨å¯¹åº”å¹³å°çš„æ¥å£æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶è°ƒç”¨ FRunnable å¯¹è±¡çš„Initï¼ŒRunç­‰äº‹ä»¶ã€‚Createæ‰§è¡Œä¹‹åï¼Œå¯¹åº”çš„çº¿ç¨‹å‡½æ•°Runç«‹å³æ‰§è¡Œï¼Œå¹¶æ²¡æœ‰Startä¹‹ç±»çš„æ–¹æ³•ã€‚
2. FRunnableå®šä¹‰äº†Init()ï¼ŒRun()ï¼ŒExit()ç­‰è™šå‡½æ•°ï¼Œé¦–å…ˆæ‰§è¡ŒInitï¼Œåˆå§‹åŒ–å®Œæˆåæ‰§è¡ŒRunï¼ŒRunæ‰§è¡Œå®Œæ¯•ä¹‹åæ‰§è¡ŒExitã€‚
   ä¸»åŠ¨è°ƒç”¨Stopï¼Œå¯ä»¥æå‰ç»ˆæ­¢çº¿ç¨‹ã€‚
3. å¦‚æœè¦ç»“æŸçº¿ç¨‹ï¼Œå¯ä»¥è°ƒç”¨FRunnableThreadçš„Killæ–¹æ³•ã€‚Killæ–¹æ³•ä»…ä»…è°ƒç”¨äº†RunnableObjectçš„Stopæ–¹æ³•(æ—¢ç„¶ä½ å·²ç»æ‹¿åˆ°äº†RunnableObjectï¼Œå°±ç›´æ¥è°ƒç”¨Stopæ–¹æ³•å³å¯)ï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨åœ¨Stopæ–¹æ³•ä¸­å°†é€€å‡ºä¿¡æ¯ä¼ é€’ç»™Runå‡½æ•°ï¼Œä»è€Œç»“æŸRunæ–¹æ³•ã€‚

```c++
class FMyRunnable : public FRunnable
{
protected:
    // FRunnable interface
    virtual bool Init() override;// åˆå§‹åŒ– runnable å¯¹è±¡ï¼Œåœ¨FRunnableThreadåˆ›å»ºçº¿ç¨‹å¯¹è±¡åè°ƒç”¨
    virtual uint32 Run() override;// Runnable å¯¹è±¡é€»è¾‘å¤„ç†ä¸»ä½“ï¼Œåœ¨InitæˆåŠŸåè°ƒç”¨
    virtual void Stop() override;// åœæ­¢ runnable å¯¹è±¡, çº¿ç¨‹æå‰ç»ˆæ­¢æ—¶è¢«ç”¨æˆ·è°ƒç”¨ å¦‚ï¼šKill()æˆ–ç›´æ¥è°ƒç”¨Stop()
    virtual void Exit() override;// é€€å‡º runnable å¯¹è±¡ï¼Œç”±FRunnableThreadè°ƒç”¨ï¼Œåœ¨Runå‡½æ•°returnåä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚
    // ~FRunnable interface

private:
	FRunnableThread* Thread;
	FThreadSafeBool bRunning;
}
```

```c++
//D:\UE_5.4\Engine\Source\Runtime\Core\Private\Windows\WindowsRunnableThread.cpp ç”¨Windowså¹³å°ä¸¾ä¾‹
uint32 FRunnableThreadWin::Run()
{
    uint32 ExitCode = 1;
    check(Runnable);

    if (Runnable->Init() == true)	//åˆå§‹åŒ– runnable å¯¹è±¡ï¼Œåœ¨FRunnableThreadåˆ›å»ºçº¿ç¨‹å¯¹è±¡åè°ƒç”¨
    {
       ThreadInitSyncEvent->Trigger();

       SetTls();

       ExitCode = Runnable->Run();	// Runnable å¯¹è±¡é€»è¾‘å¤„ç†ä¸»ä½“ï¼Œåœ¨InitæˆåŠŸåè°ƒç”¨

       Runnable->Exit();			// é€€å‡º runnable å¯¹è±¡ï¼Œç”±FRunnableThreadè°ƒç”¨

#if STATS
       FThreadStats::Shutdown();
#endif
       FreeTls();
    }
    else
    {
       ThreadInitSyncEvent->Trigger();
    }

    return ExitCode;
}
```

## è·å–çº¿ç¨‹åå­—

FRunnableæœ‰è‡ªå·±çš„è·å–åå­—å’ŒIDçš„æ–¹æ³•éœ€è¦é€šè¿‡FRunnableThreadè°ƒç”¨

```c++
Thread->GetThreadName();
```

å½“ç„¶é€šè¿‡`FThreadManager`ä»ç„¶æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºé€šè¿‡FRunnableThread åˆ›å»ºçš„çº¿ç¨‹æ˜¯é€šè¿‡`FThreadManager`è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚

```c++
FThreadManager::Get().AddThread(ThisThread->GetThreadID(), ThisThread);
```



> å¤šçº¿ç¨‹æ•™ç¨‹é“¾æ¥ï¼š[ã€UEÂ·å¼•æ“ç¯‡ã€‘Runnableã€TaskGraphã€AsyncTaskã€Asyncå¤šçº¿ç¨‹å¼€å‘æŒ‡å—](https://blog.csdn.net/j756915370/article/details/122752719)
>
> [ã€ŠExploring in UE4ã€‹å¤šçº¿ç¨‹æœºåˆ¶è¯¦è§£(åŸç†åˆ†æ) ](https://zhuanlan.zhihu.com/p/38881269)
>
> [UE4/UE5çš„TaskGraph](https://cloud.tencent.com/developer/article/1897046)
>
> [bç«™ï¼šã€åˆé›†ã€‘UE4 C++è¿›é˜¶(è¿›è¡Œä¸­)](https://www.bilibili.com/video/BV14p4y1a7nj?p=7)
>
> [2wå­— + 40å¼ å›¾å¸¦ä½ å‚é€å¹¶å‘ç¼–ç¨‹ï¼ ](https://www.cnblogs.com/cxuanBlog/p/13523033.html)

# å‚è€ƒé“¾æ¥

> 1ï¼Œ[Multi-Threading: How to Create Threads in UE4](https://michaeljcole.github.io/wiki.unrealengine.com/Multi-Threading:_How_to_Create_Threads_in_UE4)
>
> 2ï¼Œ[UE å¤šçº¿ç¨‹](https://blog.csdn.net/qq_52825422/article/details/133884930)
>
> 3ï¼Œ[UE4å¤šçº¿ç¨‹FRunnable](https://zhuanlan.zhihu.com/p/571515841)
